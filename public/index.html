<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LycanChat V4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Material You Inspired Theme */
    :root {
      --color-primary: #FF6F00; /* Orange primary */
      --color-on-primary: #FFFFFF;
      --color-primary-container: #FFE0B2;
      --color-on-primary-container: #3E2723;

      --color-secondary: #FF8F00;
      --color-on-secondary: #FFFFFF;
      --color-secondary-container: #FFECB3;
      --color-on-secondary-container: #4E342E;

      --color-tertiary-container: #FFD8E4;
      --color-on-tertiary-container: #370B1E;

      --color-background: #FFF3E0;
      --color-on-background: #3E2723;

      --color-surface: #FFFFFF;
      --color-on-surface: #3E2723;

      --color-surface-variant: #FFE0B2;
      --color-on-surface-variant: #4E342E;

      --color-outline: #FF6F00;

      --color-orange: #FF6F00;
      --color-on-orange: #FFFFFF;
      --color-orange-container: #FFE0B2;
      --color-on-orange-container: #3E2723;

      --radius: 12px;
      --elevation: 0 1px 3px rgba(255, 111, 0, 0.3), 0 1px 2px rgba(255, 111, 0, 0.2);
}

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background-color: var(--color-background);
      color: var(--color-on-background);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #userCount {
      padding: 12px 16px;
      font-weight: 600;
      background-color: var(--color-secondary-container);
      color: var(--color-on-secondary-container);
      border-radius: var(--radius);
      margin: 0;
      box-shadow: var(--elevation);
      flex: 1;
    }

    #topBar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 0 16px;
      padding: 8px 16px;
      background-color: var(--color-primary-container);
      border-radius: var(--radius);
      box-shadow: var(--elevation);
    }

    #logout-container {
      display: flex;
      align-items: center;
      margin-left: 16px;
    }

    #logout-button {
      background-color: var(--color-primary);
      color: var(--color-on-primary);
      border: none;
      border-radius: var(--radius);
      padding: 8px 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--elevation);
      transition: background-color 0.3s ease;
      position: relative;
    }

    #logout-button:hover {
      background-color: #ff8f00;
    }

    #logout-button:active {
      background-color: #e67c00;
      box-shadow: 0 2px 4px rgba(255, 143, 0, 0.6);
    }

    #logout-button .notification-badge {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 12px;
      height: 12px;
      background-color: var(--color-primary);
      border-radius: 50%;
      display: none;
    }

    #logout-button .notification-badge.active {
      display: block;
    }

    /* File upload button as plus icon */
    #file-upload-label {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background-color: var(--color-primary);
      color: var(--color-on-primary);
      border-radius: 50%;
      width: 36px;
      height: 36px;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
      box-shadow: var(--elevation);
      font-size: 24px;
      line-height: 1;
      margin-top: 6px;
    }

    #file-upload-label:hover {
      background-color: #5a3e9e;
    }

    #file-upload-label:active {
      background-color: #4b3280;
      box-shadow: 0 2px 4px rgba(103, 80, 164, 0.6);
    }

    /* Hide the actual file input */
    input[type="file"] {
      display: none;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 0 16px;
      margin-bottom: 16px;
    }

    .message {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: var(--radius);
      background-color: var(--color-primary-container);
      color: var(--color-on-primary-container);
      box-shadow: var(--elevation);
      font-size: 1rem;
      font-weight: 500;
      align-self: flex-start;
      transition: background-color 0.3s;
    }

    .message.you {
      align-self: flex-end;
      background-color: var(--color-primary);
      color: var(--color-on-primary);
    }

    #typingIndicator {
      font-style: italic;
      color: var(--color-on-surface);
      padding: 0 16px;
      margin-bottom: 8px;
    }

    #form {
      display: flex;
      gap: 12px;
      padding: 16px;
      background-color: var(--color-surface);
      box-shadow: var(--elevation);
      border-top: 1px solid #ccc;
    }

    #input {
      flex: 1;
      padding: 14px 16px;
      font-size: 1rem;
      border: none;
      border-radius: var(--radius);
      background-color: var(--color-primary-container);
      color: var(--color-on-primary-container);
      box-shadow: var(--elevation);
      transition: box-shadow 0.3s, background-color 0.3s;
    }

    #input:focus {
      outline: none;
      background-color: var(--color-primary);
      color: var(--color-on-primary);
      box-shadow: 0 0 0 3px rgba(103, 80, 164, 0.3);
    }

    #send {
      padding: 14px 24px;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: var(--radius);
      background-color: var(--color-primary);
      color: var(--color-on-primary);
      cursor: pointer;
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    #send:hover {
      background-color: #5a3e9e;
    }

    #send:active {
      background-color: #4b3280;
      box-shadow: 0 2px 4px rgba(103, 80, 164, 0.6);
    }

    @media (max-width: 600px) {
      #form {
        flex-direction: column;
      }

      #send {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="topBar">
  <div id="userCount">Users online: 1</div>
  <div id="logout-container">
    <button id="logout-button" title="Logout">Logout</button>
  </div>
</div>

  <div id="messages"></div>
  <div id="typingIndicator"></div>
  <div id="filePreviewBar" style="display: flex; gap: 8px; padding: 8px 16px; overflow-x: auto; background-color: var(--color-surface-variant); border-top: 1px solid var(--color-outline);">
    <!-- Previews of selected files will appear here -->
  </div>
  <form id="form" autocomplete="off" style="display: flex; gap: 12px; padding: 16px; background-color: var(--color-surface); box-shadow: var(--elevation); border-top: 1px solid #ccc;">
    <input id="input" placeholder="Type a message..." style="flex: 1; padding: 14px 16px; font-size: 1rem; border: none; border-radius: var(--radius); background-color: var(--color-primary-container); color: var(--color-on-primary-container); box-shadow: var(--elevation); transition: box-shadow 0.3s, background-color 0.3s;" />
  <input type="file" id="fileInput" accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt" style="display: none;" multiple />
  <button type="button" id="fileUploadButton" title="Upload file" style="background-color: var(--color-primary); color: var(--color-on-primary); border: none; border-radius: var(--radius); width: 40px; height: 40px; font-size: 24px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; box-shadow: var(--elevation); transition: background-color 0.3s;">
      +
  </button>
    <button id="send" style="padding: 14px 24px; font-size: 1rem; font-weight: 600; border: none; border-radius: var(--radius); background-color: var(--color-primary); color: var(--color-on-primary); cursor: pointer; transition: background-color 0.3s, box-shadow 0.3s;">Send</button>
  </form>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let username = '';
    let profilePic = '';

    const fileInput = document.getElementById('fileInput');
    const filePreviewBar = document.getElementById('filePreviewBar');
    let selectedFiles = [];

    // Update file input change to handle multiple files and show previews
    fileInput.addEventListener('change', () => {
      for (const file of fileInput.files) {
        selectedFiles.push(file);
      }
      renderFilePreviews();
      fileInput.value = ''; // Reset input to allow re-selecting same files
    });

    // Render previews of selected files in the preview bar
    function renderFilePreviews() {
      filePreviewBar.innerHTML = '';
      selectedFiles.forEach((file, index) => {
        const previewElement = createPreviewElement(file, index);
        filePreviewBar.appendChild(previewElement);
      });
    }

    // Create preview element for a file with remove button
    function createPreviewElement(file, index) {
      const container = document.createElement('div');
      container.style.position = 'relative';
      container.style.display = 'inline-block';
      container.style.borderRadius = 'var(--radius)';
      container.style.overflow = 'hidden';
      container.style.width = '80px';
      container.style.height = '80px';
      container.style.flex = '0 0 auto';
      container.style.boxShadow = 'var(--elevation)';
      container.style.backgroundColor = 'var(--color-surface)';

      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'Ã—';
      removeBtn.style.position = 'absolute';
      removeBtn.style.top = '2px';
      removeBtn.style.right = '2px';
      removeBtn.style.background = 'rgba(0,0,0,0.5)';
      removeBtn.style.color = 'white';
      removeBtn.style.border = 'none';
      removeBtn.style.borderRadius = '50%';
      removeBtn.style.width = '20px';
      removeBtn.style.height = '20px';
      removeBtn.style.cursor = 'pointer';
      removeBtn.style.zIndex = '10';
      removeBtn.title = 'Remove file';
      removeBtn.addEventListener('click', () => {
        selectedFiles.splice(index, 1);
        renderFilePreviews();
      });

      container.appendChild(removeBtn);

      if (file.type.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        container.appendChild(img);
      } else if (file.type.startsWith('video/')) {
        const video = document.createElement('video');
        video.src = URL.createObjectURL(file);
        video.controls = true;
        video.style.width = '100%';
        video.style.height = '100%';
        container.appendChild(video);
      } else if (file.type.startsWith('audio/')) {
        const audio = document.createElement('audio');
        audio.src = URL.createObjectURL(file);
        audio.controls = true;
        audio.style.width = '100%';
        container.appendChild(audio);
      } else {
        const icon = document.createElement('div');
        icon.textContent = file.name;
        icon.style.padding = '8px';
        icon.style.fontSize = '0.75rem';
        icon.style.overflow = 'hidden';
        icon.style.textOverflow = 'ellipsis';
        icon.style.whiteSpace = 'nowrap';
        container.appendChild(icon);
      }

      return container;
    }

    // Modify form submission to send all selected files
    const form = document.getElementById('form');
    const input = document.getElementById('input');

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      if (input.value.trim() || selectedFiles.length > 0) {
        if (selectedFiles.length > 0) {
          // Read all files as data URLs and send with message
          const fileReaders = [];
          const filesData = [];
          let filesRead = 0;

          selectedFiles.forEach((file, idx) => {
            const reader = new FileReader();
            reader.onload = function(e) {
              filesData[idx] = {
                fileData: e.target.result,
                fileName: file.name,
                fileType: file.type
              };
              filesRead++;
              if (filesRead === selectedFiles.length) {
                socket.emit('chat message', { username, message: input.value, files: filesData, profilePic });
                input.value = '';
                selectedFiles = [];
                renderFilePreviews();
                socket.emit('stop typing', username);
              }
            };
            reader.readAsDataURL(file);
            fileReaders.push(reader);
          });
        } else {
          socket.emit('chat message', { username, message: input.value, profilePic });
          input.value = '';
          socket.emit('stop typing', username);
        }
      }
    });

    // Update socket listener to handle multiple files
    // Removed duplicate socket.on('chat message') handler

    socket.on('chat message', (data) => {
      if (data.files && Array.isArray(data.files)) {
        addMessage(data.username, data.message, data.username === username, data.profilePic);
        data.files.forEach((file) => {
          addMessage(data.username, '', data.username === username, data.profilePic, file.fileData, file.fileName, file.fileType);
        });
      } else {
        addMessage(data.username, data.message, data.username === username, data.profilePic, data.file, data.fileName, data.fileType);
      }
    });

    // Logout button functionality (already implemented)
    const logoutButton = document.getElementById('logout-button');
    logoutButton.addEventListener('click', () => {
      localStorage.removeItem('username');
      localStorage.removeItem('profilePic');
      username = '';
      profilePic = '';
      socket.disconnect();
      location.reload();
    });

    const loginScreen = document.createElement('div');
    loginScreen.id = 'login-screen';
    loginScreen.style.cssText = 'display:flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background-color: var(--color-background); color: var(--color-on-background);';

    const loginTitle = document.createElement('h2');
    loginTitle.textContent = 'Enter your username';
    loginScreen.appendChild(loginTitle);

    const loginInput = document.createElement('input');
    loginInput.id = 'login-input';
    loginInput.type = 'text';
    loginInput.placeholder = 'Username';
    loginInput.style.cssText = 'padding: 12px 16px; font-size: 1rem; border-radius: var(--radius); border: none; box-shadow: var(--elevation); outline-offset: 2px; margin-bottom: 16px; width: 250px;';
    loginScreen.appendChild(loginInput);

    const loginPfpLabel = document.createElement('label');
    loginPfpLabel.textContent = 'Upload Profile Picture:';
    loginPfpLabel.style.marginBottom = '8px';
    loginScreen.appendChild(loginPfpLabel);

    const loginPfpInput = document.createElement('input');
    loginPfpInput.type = 'file';
    loginPfpInput.accept = 'image/*';
    loginPfpInput.style.marginBottom = '16px';
    loginPfpInput.id = 'login-pfp';
    loginScreen.appendChild(loginPfpInput);

    const loginButton = document.createElement('button');
    loginButton.id = 'login-button';
    loginButton.textContent = 'Join Chat';
    loginButton.style.cssText = 'padding: 12px 24px; font-size: 1rem; font-weight: 600; color: var(--color-on-primary); background-color: var(--color-primary); border: none; border-radius: var(--radius); box-shadow: var(--elevation); cursor: pointer;';
    loginScreen.appendChild(loginButton);

    loginScreen.style.display = 'flex';
    chatScreen.style.display = 'none';

    const chatScreen = document.createElement('div');
    chatScreen.id = 'chat-screen';
    chatScreen.style.cssText = 'display:none; flex-direction: column; height: 100vh;';
    document.body.appendChild(loginScreen);
    document.body.appendChild(chatScreen);
    const topBar = document.createElement('div');
    topBar.id = 'topBar';
    topBar.style.cssText = 'display: flex; align-items: center; justify-content: space-between; margin: 16px;';

    const userCountDisplay = document.createElement('div');
    userCountDisplay.id = 'userCount';
    userCountDisplay.textContent = 'Users online: 1';
    userCountDisplay.style.cssText = 'padding: 12px 16px; font-weight: 600; background-color: var(--color-secondary-container); color: var(--color-on-secondary-container); border-radius: var(--radius); margin: 0; box-shadow: var(--elevation); flex: 1;';
    topBar.appendChild(userCountDisplay);

    // Removed duplicate declaration of logoutButton element creation
    // const logoutButton = document.createElement('button');
    // logoutButton.id = 'logout-button';
    // logoutButton.title = 'Logout';
    // logoutButton.textContent = 'Logout';

    // const notificationBadge = document.createElement('span');
    // notificationBadge.className = 'notification-badge';
    // logoutButton.appendChild(notificationBadge);

    // topBar.appendChild(logoutButton);
    // chatScreen.appendChild(topBar);

    const messages = document.createElement('div');
    messages.id = 'messages';
    messages.style.cssText = 'flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding: 0 16px; margin-bottom: 16px;';
    chatScreen.appendChild(messages);

    const typingIndicator = document.createElement('div');
    typingIndicator.id = 'typingIndicator';
    typingIndicator.style.cssText = 'font-style: italic; color: var(--color-on-surface); padding: 0 16px; margin-bottom: 8px;';
    chatScreen.appendChild(typingIndicator);

    // Removed duplicate declaration of form and input element creation
    // const form = document.createElement('form');
    // form.id = 'form';
    // form.autocomplete = 'off';
    // form.style.cssText = 'display: flex; gap: 12px; padding: 16px; background-color: var(--color-surface); box-shadow: var(--elevation); border-top: 1px solid #ccc;';

    // const input = document.createElement('input');
    // input.id = 'input';
    // input.placeholder = 'Type a message...';
    // input.style.cssText = 'flex: 1; padding: 14px 16px; font-size: 1rem; border: none; border-radius: var(--radius); background-color: var(--color-primary-container); color: var(--color-on-primary-container); box-shadow: var(--elevation); transition: box-shadow 0.3s, background-color 0.3s;';
    // form.appendChild(input);

    // const fileInput = document.createElement('input');
    // fileInput.type = 'file';
    // fileInput.accept = 'image/*,video/*,audio/*,.pdf,.doc,.docx,.txt';
    // fileInput.style.cssText = 'display: none;';
    // form.appendChild(fileInput);

    const fileUploadLabel = document.createElement('label');
    fileUploadLabel.id = 'file-upload-label';
    fileUploadLabel.htmlFor = 'fileInput';
    fileUploadLabel.textContent = '+';
    form.appendChild(fileUploadLabel);

    const sendButton = document.createElement('button');
    sendButton.id = 'send';
    sendButton.textContent = 'Send';
    sendButton.style.cssText = 'padding: 14px 24px; font-size: 1rem; font-weight: 600; border: none; border-radius: var(--radius); background-color: var(--color-primary); color: var(--color-on-primary); cursor: pointer; transition: background-color 0.3s, box-shadow 0.3s;';
    form.appendChild(sendButton);

    chatScreen.appendChild(form);
    document.body.appendChild(chatScreen);

const loginInputField = document.getElementById('login-input');
const loginPfpInputField = document.getElementById('login-pfp');
const loginButtonElement = document.getElementById('login-button');
const loginArea = document.getElementById('loginArea');

loginButtonElement.addEventListener('click', () => {
  const enteredUsername = loginInputField.value.trim();
  if (enteredUsername) {
    username = enteredUsername;

    if (loginPfpInputField.files.length > 0) {
      const reader = new FileReader();
      reader.onload = function (e) {
        profilePic = e.target.result;
        localStorage.setItem('profilePic', profilePic);
      };
      reader.readAsDataURL(loginPfpInputField.files[0]);
    } else {
      profilePic = localStorage.getItem('profilePic') || '';
    }

    localStorage.setItem('username', username);
    loginScreen.style.display = 'none';
    chatScreen.style.display = 'flex';
    socket.emit('join', username);
  }
});


    // Load saved username and profilePic from localStorage
    window.addEventListener('load', () => {
      const savedUsername = localStorage.getItem('username');
      const savedProfilePic = localStorage.getItem('profilePic');
      if (savedUsername) {
        username = savedUsername;
        profilePic = savedProfilePic || '';
        loginScreen.style.display = 'none';
        chatScreen.style.display = 'flex';
        socket.emit('join', username);
      } else {
        loginScreen.style.display = 'flex';
        chatScreen.style.display = 'none';
      }
    });

    let typing = false;
    let typingTimeout;

    input.addEventListener('input', () => {
      if (!typing) {
        typing = true;
        socket.emit('typing', username);
      }
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        typing = false;
        socket.emit('stop typing', username);
      }, 1000);
    });

    socket.on('chat message', (data) => {
      // Prevent duplicate message for sender by not adding message locally on submit
      addMessage(data.username, data.message, data.username === username, data.profilePic, data.file, data.fileName, data.fileType);
    });

    socket.on('user joined', ({ username: newUser, userCount }) => {
      addNotification(`${newUser} joined the chat`);
      userCountDisplay.textContent = `Users online: ${userCount}`;
    });

    socket.on('user left', ({ username: leftUser, userCount }) => {
      addNotification(`${leftUser} left the chat`);
      userCountDisplay.textContent = `Users online: ${userCount}`;
    });

    socket.on('typing', (who) => {
      if (who !== username) typingIndicator.textContent = `${who} is typing...`;
    });

    socket.on('stop typing', (who) => {
      if (who !== username) typingIndicator.textContent = '';
    });

    function addMessage(sender, text, isYou, profilePic, fileData, fileName, fileType) {
      const div = document.createElement('div');
      div.className = 'message' + (isYou ? ' you' : '');

      const pfpImg = document.createElement('img');
      pfpImg.src = profilePic || 'https://via.placeholder.com/40';
      pfpImg.alt = sender + ' profile picture';
      pfpImg.style.width = '40px';
      pfpImg.style.height = '40px';
      pfpImg.style.borderRadius = '50%';
      pfpImg.style.marginRight = '8px';
      pfpImg.style.verticalAlign = 'middle';

      const contentSpan = document.createElement('span');
      contentSpan.style.verticalAlign = 'middle';

      // Linkify message text
      const linkifiedText = linkify(text);
      contentSpan.innerHTML = linkifiedText;

      div.appendChild(pfpImg);
      div.appendChild(contentSpan);

      if (fileData) {
        const fileElement = createFileElement(fileData, fileName, fileType);
        div.appendChild(fileElement);
      }

      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function addNotification(text) {
      const div = document.createElement('div');
      div.className = 'message';
      div.style.fontStyle = 'italic';
      div.style.backgroundColor = 'transparent';
      div.style.boxShadow = 'none';
      div.textContent = text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function linkify(text) {
      const urlPattern = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
      return text.replace(urlPattern, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
    }

    function createFileElement(fileData, fileName, fileType) {
      let element;
      if (fileType.startsWith('image/')) {
        element = document.createElement('img');
        element.src = fileData;
        element.alt = fileName;
        element.style.maxWidth = '200px';
        element.style.display = 'block';
        element.style.marginTop = '8px';
        element.style.borderRadius = 'var(--radius)';
      } else if (fileType.startsWith('video/')) {
        element = document.createElement('video');
        element.src = fileData;
        element.controls = true;
        element.style.maxWidth = '200px';
        element.style.display = 'block';
        element.style.marginTop = '8px';
        element.style.borderRadius = 'var(--radius)';
      } else if (fileType.startsWith('audio/')) {
        element = document.createElement('audio');
        element.src = fileData;
        element.controls = true;
        element.style.display = 'block';
        element.style.marginTop = '8px';
      } else {
        element = document.createElement('a');
        element.href = fileData;
        element.textContent = fileName;
        element.target = '_blank';
        element.rel = 'noopener noreferrer';
        element.style.display = 'block';
        element.style.marginTop = '8px';
        element.style.color = 'var(--color-primary)';
      }
      return element;
    }
    document.getElementById('fileUploadButton').addEventListener('click', () => {
      document.getElementById('fileInput').click();
      });
  </script>
  <script>
    // Removed duplicate declaration of logoutButton and fileInput event listeners

    // Logout button functionality (already implemented)
    // const logoutButton = document.getElementById('logout-button');
    // logoutButton.addEventListener('click', () => {
    //   localStorage.removeItem('username');
    //   localStorage.removeItem('profilePic');
    //   username = '';
    //   profilePic = '';
    //   socket.disconnect();
    //   location.reload();
    // });

    // Add event listener to upload picture button to trigger file input click
    // const fileUploadButton = document.getElementById('fileUploadButton');
    // const fileInput = document.getElementById('fileInput');
    // fileUploadButton.addEventListener('click', () => {
    //   fileInput.click();
    // });
  </script>
</html>
